<!DOCTYPE html>
<html>
<head>
    <title>NGO Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="container mt-5">

<h2>NGO Dashboard</h2>
<a href="/receiver/history" class="btn btn-info mb-3">My Pickup Requests</a>
<a href="/auth/logout" class="btn btn-danger float-end mb-3">Logout</a>

<div id="map" style="height: 400px; width: 100%; margin-bottom: 20px;"></div>

<% if (total_available !== 0){ %>
    <table class="table table-bordered">
    <thead>
        <tr>
            <th>Donor</th>
            <th>Food</th>
            <th>Quantity</th>
            <th>Expiry</th>
            <th>Pickup Address</th>
            <th>Pickup Phone</th>
            <th>Pickup Time</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
    <% listings.forEach((listing) => { %>
        <% if (listing.status === "available" ){ %>
            <tr>
                <td><%= listing.donor_name %></td>
                <td><%= listing.food_description %></td>
                <td><%= listing.quantity %></td>
                <td><%= listing.expiry_time %></td>
                <td><%= listing.pickup_address %></td>
                <td><%= listing.phone %></td>
                <td><%= listing.pickup_time %></td>
                <td><%= listing.status %></td>
                <td>
                    <% if (listing.status === "available"){ %>
                        <form method="POST" action="/listing/request/<%= listing.id %>">
                            <button class="btn btn-primary btn-sm">Request Pickup</button>
                        </form>
                    <% } else { %>
                        <p>N/A</p>
                    <% } %>
                </td>
            </tr>
        <% } %>
    <% }) %>
    </tbody>
    </table>
<% } else if (total_available === 0){ %>
    <p>Listings are not available!</p>
<% } %>

<script>
    const listings = <%- JSON.stringify(listings) %>;

    let centerLat = 28.6;
    let centerLng = 77.2;
    const map = L.map('map').setView([centerLat, centerLng], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    listings.forEach(listing => {
        if (listing.latitude && listing.longitude) {

            const marker = L.marker([
                parseFloat(listing.latitude),
                parseFloat(listing.longitude)
            ]).addTo(map);

            marker.bindPopup(`
                <strong>${listing.food_description}</strong><br>
                Quantity: ${listing.quantity}<br>
                Address: ${listing.pickup_address}
            `);
        }
    });
</script>

</body>
</html>