<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Details ‚Äî FoodLink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="/style.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body class="bg-light">

    <nav class="navbar navbar-dark bg-success">
        <div class="container">
            <a href="javascript:history.back()" class="navbar-brand" style="font-size:1rem;">‚Üê Back</a>
            <span class="navbar-brand">üçÉ FoodLink</span>
            <div></div>
        </div>
    </nav>

    <div class="container py-4">
        <h4 class="page-title">Listing Details</h4>

        <div class="row g-4">
            <!-- Food Info Card -->
            <div class="col-md-6">
                <div class="bg-white rounded-3 shadow-sm p-4 h-100">
                    <h5 class="fw-bold mb-3 text-success">üì¶ Food Information</h5>
                    <h4 class="fw-bold mb-3">
                        <%= listing.food_description %>
                    </h4>

                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td class="text-muted" style="width:140px;">Donated by</td>
                            <td class="fw-medium text-success">
                                <%= listing.donor_name %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Quantity</td>
                            <td><strong>
                                    <%= listing.quantity %>
                                </strong> units</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Expiry</td>
                            <td class="text-warning-emphasis">
                                <%= new Date(listing.expiry_time).toLocaleString('en-IN', {dateStyle:'medium',
                                    timeStyle:'short'}) %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Pickup Time</td>
                            <td>
                                <%= new Date(listing.pickup_time).toLocaleString('en-IN', {dateStyle:'medium',
                                    timeStyle:'short'}) %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Address</td>
                            <td>
                                <%= listing.pickup_address %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Contact</td>
                            <td>
                                <%= listing.pickup_phone %>
                            </td>
                        </tr>
                        <tr>
                            <td class="text-muted">Listed On</td>
                            <td class="text-muted">
                                <%= new Date(listing.created_at).toLocaleDateString('en-IN', {dateStyle:'medium'}) %>
                            </td>
                        </tr>
                        <% if (user_role==='donor' ) { %>
                            <tr>
                                <td class="text-muted">Status</td>
                                <td>
                                    <% if (listing.status==='available' ) { %><span
                                            class="badge badge-available">Available</span>
                                        <% } else if (listing.status==='requested' ) { %><span
                                                class="badge badge-requested">Requested</span>
                                            <% } else if (listing.status==='approved' ) { %><span
                                                    class="badge badge-approved">Approved</span>
                                                <% } else { %><span class="badge badge-picked">Picked Up</span>
                                                    <% } %>
                                </td>
                            </tr>
                            <% } %>
                    </table>
                </div>
            </div>

            <!-- Pickup Request + Actions -->
            <div class="col-md-6 d-flex flex-column gap-3">
                <% if (pickup_request) { %>
                    <div class="bg-white rounded-3 shadow-sm p-4">
                        <h5 class="fw-bold mb-3 text-success">ü§ù Pickup Request</h5>
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td class="text-muted" style="width:140px;">Requested By</td>
                                <td class="fw-medium">
                                    <%= pickup_request.contact_person %>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Phone</td>
                                <td>
                                    <%= pickup_request.contact_phone %>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Requested On</td>
                                <td class="text-muted">
                                    <%= new Date(pickup_request.created_at).toLocaleDateString('en-IN') %>
                                </td>
                            </tr>
                            <% if (user_role==='receiver' ) { %>
                                <tr>
                                    <td class="text-muted">Status</td>
                                    <td>
                                        <% if (pickup_request.status==='pending' ) { %><span
                                                class="badge badge-pending">Pending</span>
                                            <% } else if (pickup_request.status==='approved' ) { %><span
                                                    class="badge badge-approved">Approved</span>
                                                <% } else { %><span class="badge badge-complete">Complete</span>
                                                    <% } %>
                                    </td>
                                </tr>
                                <% } %>
                        </table>
                    </div>
                    <% } else { %>
                        <div class="bg-white rounded-3 shadow-sm p-4 text-center text-muted">
                            <div style="font-size:2rem;">üì≠</div>
                            <p class="mb-0 mt-2 small">No pickup requests yet ‚Äî waiting for an NGO to claim this
                                listing.</p>
                        </div>
                        <% } %>

                            <!-- Action Buttons -->
                            <% if (user_role==='receiver' && listing.status==='available' ) { %>
                                <form action="/listing/<%= listing.id %>/request" method="POST">
                                    <button class="btn btn-success w-100 fw-semibold">ü§ù Request Pickup</button>
                                </form>
                                <% } %>

                                    <% if (user_role==='donor' && listing.status==='requested' ) { %>
                                        <form action="/listing/<%= listing.id %>/approve" method="POST">
                                            <button class="btn btn-primary w-100 fw-semibold">‚úì Approve Pickup</button>
                                        </form>
                                        <% } %>

                                            <% if (user_role==='receiver' && listing.status==='approved' ) { %>
                                                <form action="/listing/<%= listing.id %>/complete" method="POST"
                                                    id="completeForm">
                                                    <div class="bg-white rounded-3 border p-3 mb-2">
                                                        <label class="d-flex align-items-start gap-2 mb-0"
                                                            style="cursor:pointer;">
                                                            <input type="checkbox" id="confirmPickup"
                                                                onchange="toggleCompleteBtn()" class="mt-1"
                                                                style="accent-color:#28a745;">
                                                            <span class="small">I confirm that the food has been
                                                                physically picked up and received in good
                                                                condition.</span>
                                                        </label>
                                                    </div>
                                                    <button id="completeBtn" class="btn btn-success w-100 fw-semibold"
                                                        disabled style="opacity:0.5; cursor:not-allowed;">
                                                        ‚úî Mark as Picked Up
                                                    </button>
                                                </form>
                                                <% } %>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container mt-4">
            <div id="map"></div>
        </div>
    </div>

    <script>
        const map = L.map('map').setView([<%= listing.latitude %>, <%= listing.longitude %>], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Custom styled marker icon
        const icon = L.divIcon({
            className: '',
            html: `<div style="background:#28a745;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
                    font-size:18px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üç±</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });

        L.marker([<%= listing.latitude %>, <%= listing.longitude %>], { icon })
            .addTo(map)
            .bindPopup(`
            <div style="min-width:200px;font-family:'Inter',sans-serif;">
                <div style="font-weight:700;font-size:0.9rem;margin-bottom:6px;">üì¶ <%= listing.food_description %></div>
                <div style="font-size:0.8rem;color:#555;margin-bottom:4px;">üìç <%= listing.pickup_address %></div>
                <div style="font-size:0.8rem;color:#555;margin-bottom:8px;">üìû <%= listing.pickup_phone %></div>
                <a href="https://www.google.com/maps/dir/?api=1&destination=<%= listing.latitude %>,<%= listing.longitude %>"
                   target="_blank"
                   style="background:#0d6efd;color:white;padding:4px 10px;border-radius:4px;text-decoration:none;font-size:0.78rem;font-weight:600;">
                    üó∫Ô∏è Get Directions
                </a>
            </div>
        `, { maxWidth: 260 })
            .openPopup();

        function toggleCompleteBtn() {
            const cb = document.getElementById('confirmPickup');
            const btn = document.getElementById('completeBtn');
            if (!cb || !btn) return;
            btn.disabled = !cb.checked;
            btn.style.opacity = cb.checked ? '1' : '0.5';
            btn.style.cursor = cb.checked ? 'pointer' : 'not-allowed';
        }
    </script>
</body>

</html>