<!DOCTYPE html>
<html>
<head>
    <title>Listing Details</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

<a href="javascript:history.back()" class="btn btn-secondary mb-3">Back</a>

<h2>Listing Details</h2>
<div class="card p-4 mb-4">
    <h4><%= listing.food_description %></h4>
    <p><strong>Created At:</strong> <%= listing.created_at %></p>
    <p><strong>Donor:</strong> <%= listing.donor_name %></p>
    <p><strong>Quantity:</strong> <%= listing.quantity %></p>
    <p><strong>Expiry:</strong> <%= listing.expiry_time %></p>
    <p><strong>Pickup Address:</strong> <%= listing.pickup_address %></p>
    <p><strong>Pickup Phone:</strong> <%= listing.pickup_phone %></p>
    <p><strong>Pickup Time:</strong> <%= listing.pickup_time %></p>
    <% if (user_role === "donor"){ %>
        <p><strong>Listing Status: <%= listing.status %></strong></p>
    <% } %>
</div>

<% if (pickup_request){ %>
<h2>Pickup Details</h2>
<div class="card p-4 mb-4">
    <p><strong>Requested By:</strong> <%= pickup_request.contact_person %></p>
    <p><strong>Phone No:</strong> <%= pickup_request.contact_phone %></p>
    <p><strong>Created At:</strong> <%= pickup_request.created_at %></p>
    <% if (user_role === "receiver"){ %>
        <p><strong>Request Status: <%= pickup_request.status %></strong></p>
    <% } %>
</div>
<% } else { %>
    <p>No pickup requests!</p>
<% } %>

<% if (user_role === "receiver" && listing.status === "available"){ %>
    <form action="/listing/<%= listing.id %>/request" method="POST">
        <button class="btn btn-primary mb-3">Request Pickup</button>
    </form>
<% } %>

<% if (user_role === "donor" && listing.status === "requested"){ %>
    <form action="/listing/<%= listing.id %>/approve" method="POST">
        <button class="btn btn-primary mb-3">Approve Pickup</button>
    </form>
<% } %>

<% if (user_role === "receiver" && listing.status === "approved"){ %>
    <form action="/listing/<%= listing.id %>/complete" method="POST">
        <button class="btn btn-primary mb-3">Complete Pickup</button>
    </form>
<% } %>

<div id="map" style="height: 400px;"></div>

<script>
    const map = L.map('map').setView(
        [<%= listing.latitude %>, <%= listing.longitude %>], 
        13
    );

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([<%= listing.latitude %>, <%= listing.longitude %>])
        .addTo(map)
        .bindPopup("<strong><%= listing.food_description %></strong>")
        .openPopup();
</script>

</body>
</html>