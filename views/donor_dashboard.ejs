<!DOCTYPE html>
<html>
<head>
    <title>Donor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="container mt-5">

<h2>Donor Dashboard</h2>

<a href="/listing/create" class="btn btn-primary mb-3">Create New Listing</a>
<a href="/donor/history" class="btn btn-info mb-3">View All Listings</a>
<a href="/auth/logout" class="btn btn-danger mb-3 float-end">Logout</a>

<div id="donorMap" style="height: 400px; width: 100%; margin-bottom: 20px;"></div>

<% if (total_active !== 0){ %>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Food</th>
            <th>Quantity</th>
            <th>Expiry Time</th>
            <th>Pickup Address</th>
            <th>Pickup Phone</th>
            <th>Pickup Time</th>
            <th>Created At</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>
        <% listings.forEach(listing => { %>
            <tr>
                <td><%= listing.food_description %></td>
                <td><%= listing.quantity %></td>
                <td><%= listing.expiry_time %></td>
                <td><%= listing.pickup_address %></td>
                <td><%= listing.pickup_phone %></td>
                <td><%= listing.pickup_time %></td>
                <td><%= listing.created_at %></td>
                <td><a href="/listing/<%= listing.id %>">See More</a></td>
            </tr>
        <% }) %>
    </tbody>
</table>
<% } else { %>
    <p>No active listings!</p>
<% } %>

<script>
    const listings = <%- JSON.stringify(listings) %>;

    let centerLat = 28.6;
    let centerLng = 77.2;

    if (listings.length > 0 && listings[0].latitude) {
        centerLat = parseFloat(listings[0].latitude);
        centerLng = parseFloat(listings[0].longitude);
    }

    const map = L.map('donorMap').setView([centerLat, centerLng], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    listings.forEach(listing => {
        if (listing.latitude && listing.longitude) {

            let statusColor = "blue";

            if (listing.status === "requested") statusColor = "orange";
            if (listing.status === "picked") statusColor = "green";

            const marker = L.circleMarker([
                parseFloat(listing.latitude),
                parseFloat(listing.longitude)
            ], {
                color: statusColor,
                radius: 8
            }).addTo(map);

            marker.bindPopup(`
                <strong>${listing.food_description}</strong><br>
                Quantity: ${listing.quantity}<br>
                Status: ${listing.status}<br>
                Address: ${listing.pickup_address}
            `);
        }
    });
</script>
</body>
</html>